{% extends "base_admin.html" %}
{% block title %}Products{% endblock %}

{% block content %}
<div class="admin-header">
    <div>
        <div class="admin-header-title">List of Products</div>
        <small class="text-muted">Manage all inventory products</small>
    </div>
    <div>
        <a href="{{ url_for('views.product_create') }}" class="btn btn-success btn-sm">
            <i class="fa fa-plus"></i> Add Products
        </a>
        
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form class="d-flex justify-content-between align-items-center mb-3" method="GET">
            <div>
                Show
                <select
                name="per_page"
                class="form-select form-select-sm d-inline-block"
                style="width:auto;"
                onchange="this.form.submit()"
                >
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            </select>
            entries
            
            <!-- Category filter -->
            <span class="ms-3">Category:</span>
            <select
            name="category_id"
            class="form-select form-select-sm d-inline-block"
            style="width:auto;"
            onchange="this.form.submit()"
            >
            <option value="">All</option>
            {% for c in categories %}
            <option value="{{ c.id }}"
            {% if selected_category == c.id %}selected{% endif %}
            >
            {{ c.name }}
        </option>
        {% endfor %}
    </select>
</div>

<div>
    <label class="mb-0 me-1">Search:</label>
    <input
    type="search"
    name="q"
    value="{{ search }}"
    class="form-control form-control-sm d-inline-block"
    style="width: 220px;"
    placeholder="Search product name"
    />
    <button type="submit" class="btn btn-sm btn-outline-secondary ms-1">
        Go
    </button>
</div>
</form>


<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover table-sm mb-0">
        <thead class="thead-light">
            <tr>
                <th style="width: 60px;">ID</th>
                <th>Name</th>
                <th style="width: 100px;">Price</th>
                <th style="width: 80px;">Qty.</th>
                <th style="width: 90px;">Image</th>
                <th>Category</th>
                <th style="width: 170px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if products %}
            {% for p in products %}
            <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td>{{ '{:.2f}'.format(p.price) if p.price is not none else '-' }}</td>
                <td>{{ p.quantity }}</td>
                <td class="text-center">
                    {% if p.image_filename %}
                    <img src="{{ url_for('static', filename='uploads/' + p.image_filename) }}"
                    style="width:50px; height:50px; object-fit:cover; border-radius:4px;">
                    {% else %}
                    <img src="{{ url_for('static', filename='no-image.png') }}"
                    style="width:50px; height:50px;">
                    {% endif %}
                </td>
                <td>{{ p.category.name if p.category else '-' }}</td>
                <td>
                    <button
                    type="button"
                    class="btn btn-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#editProductModal"
                    data-id="{{ p.id }}"
                    data-name="{{ p.name }}"
                    data-price="{{ p.price }}"
                    data-qty="{{ p.quantity }}"
                    data-category="{{ p.category_id }}"
                    data-image="{% if p.image_filename %}{{ url_for('static', filename='uploads/' + p.image_filename) }}{% else %}{{ url_for('static', filename='no-image.png') }}{% endif %}"
                    >
                    <i class="fa fa-edit"></i> Edit
                </button>
                
                <form
                method="POST"
                action="{{ url_for('views.product_delete', product_id=p.id) }}"
                style="display:inline-block;"
                onsubmit="return confirm('Delete this product?');"
                >
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="fa fa-trash"></i> Delete
                </button>
            </form>
            
        </td>
    </tr>
    {% endfor %}
    {% else %}
    <tr>
        <td colspan="7" class="text-center text-muted">
            No products yet. Click <strong>Add Products</strong> to create one.
        </td>
    </tr>
    {% endif %}
</tbody>
</table>
</div>

<div class="d-flex justify-content-between align-items-center mt-2">
  <small>
    Showing
    {% if pagination.total == 0 %}
      0
    {% else %}
      {{ (pagination.page - 1) * pagination.per_page + 1 }}
      to
      {{ (pagination.page - 1) * pagination.per_page + products|length }}
    {% endif %}
    of {{ pagination.total }} entries
  </small>

  <nav>
    <ul class="pagination pagination-sm mb-0">

      <!-- Previous -->
      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
        <a
          class="page-link"
          href="{% if pagination.has_prev %}{{ url_for('views.product_list', page=pagination.prev_num, q=search, category_id=selected_category, per_page=per_page) }}{% else %}#{% endif %}"
        >
          Previous
        </a>
      </li>

      <!-- Page numbers -->
      {% for p in range(1, pagination.pages + 1) %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
          <a
            class="page-link"
            href="{{ url_for('views.product_list', page=p, q=search, category_id=selected_category, per_page=per_page) }}"
          >
            {{ p }}
          </a>
        </li>
      {% endfor %}

      <!-- Next -->
      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
        <a
          class="page-link"
          href="{% if pagination.has_next %}{{ url_for('views.product_list', page=pagination.next_num, q=search, category_id=selected_category, per_page=per_page) }}{% else %}#{% endif %}"
        >
          Next
        </a>
      </li>
    </ul>
  </nav>
</div>

</div>
</div>
<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="POST" id="editProductForm" enctype="multipart/form-data">
                <div class="modal-body">
                    
                    <div class="mb-3">
                        <label class="form-label">Product Name</label>
                        <input type="text" id="edit-name" name="name" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" id="edit-price" name="price" class="form-control" step="0.01" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="edit-qty" name="quantity" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select id="edit-category" name="category_id" class="form-select" required>
                            {% for c in categories %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Upload New Image (optional)</label>
                        <input type="file" name="image_file" class="form-control">
                    </div>
                    
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Save Changes
                    </button>
                </div>
                
            </form>
        </div>
    </div>
</div>

<!-- Import Products Data -->
<div class="card mt-4">
  <div class="card-header">
    <strong>Import Products Data</strong>
  </div>
  <div class="card-body">
    <form
      method="POST"
      action="{{ url_for('views.product_import') }}"
      enctype="multipart/form-data"
    >
      <div class="mb-3">
        <label for="product-file" class="form-label">Input File</label>
        <input
          type="file"
          class="form-control"
          id="product-file"
          name="file"
          accept=".xls,.xlsx,.xlsm,.xltx,.xltm"
          required
        />
      </div>

      <button type="submit" class="btn btn-success">
        Submit
      </button>
    </form>

    <!-- Warning / info -->
    <div class="alert alert-warning mt-3 mb-0" role="alert">
      <strong>Attention!</strong>
      File data <strong>Product</strong> only.
      Allowed file types:
      <code>.xls</code>, <code>.xlsx</code>, <code>.xlsm</code>, <code>.xltx</code>, <code>.xltm</code>.
      The first row must contain headers:
      <em>Name, Price, Quantity, Category</em>
      (optional: <em>Image</em>).
      Each row will be inserted or updated in the Products database.
    </div>
  </div>
</div>


<script>
    const editModal = document.getElementById('editProductModal');
    
    editModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        const price = button.getAttribute('data-price');
        const qty = button.getAttribute('data-qty');
        const category = button.getAttribute('data-category');
        
        // Set form action
        const form = document.getElementById('editProductForm');
        form.action = `/admin/products/${id}/edit`;
        
        // Fill form fields
        document.getElementById('edit-name').value = name;
        document.getElementById('edit-price').value = price;
        document.getElementById('edit-qty').value = qty;
        document.getElementById('edit-category').value = category;
    });
</script>

{% endblock %}
